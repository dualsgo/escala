<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Escala Mensal de Trabalho</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f8f9fa;
        padding: 20px;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        max-width: 100%;
        overflow-x: hidden;
      }
      .table-fixed {
        width: 400px; /* Largura fixa para as colunas Nome, Função e Horário */
        float: left;
      }
      .table-scroll {
        overflow-x: auto;
        margin-left: 400px; /* Espaço para a tabela fixa */
      }
      th,
      td {
        border: 1px solid #e9ecef;
        padding: 12px;
        text-align: center;
        min-width: 80px;
        white-space: nowrap;
      }
      th {
        background-color: #4361ee;
        color: white;
      }
      .editable {
        cursor: pointer;
      }
      .editable:hover {
        background-color: #f1f3f5;
      }
      .button-container {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        justify-content: center;
      }
      #resultado {
        margin-top: 20px;
        white-space: pre-wrap;
        background-color: #f1f3f5;
        padding: 15px;
        border-radius: 6px;
        font-family: monospace;
      }
      .domingo {
        background-color: #ffcccc; /* Cor de destaque para domingos */
      }
      .trabalhado {
        background-color: #ccffcc; /* Verde para dias trabalhados */
      }
      .folga {
        background-color: #ffcccc; /* Vermelho para folgas */
      }
      .top-buttons {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 20px;
        gap: 10px;
      }
      .copy-button {
        margin-top: 10px;
      }
      .add-remove-buttons {
        margin-top: 10px;
        display: flex;
        gap: 10px;
      }
      #feedback-inconsistencia {
        margin-top: 20px;
        padding: 15px;
        border-radius: 6px;
        background-color: #fff3cd;
        color: #856404;
      }

      /* Responsividade para dispositivos móveis */
      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }
        .table-fixed {
          width: 100%;
          float: none;
        }
        .table-scroll {
          margin-left: 0;
          margin-top: 20px;
          overflow-x: auto;
          width: 100%;
        }
        .top-buttons {
          flex-direction: column;
          align-items: stretch;
        }
        .button-container {
          flex-direction: column;
        }
        .btn {
          padding: 12px;
          font-size: 1rem;
        }
        th, td {
          padding: 8px;
          font-size: 0.9rem;
        }
      }

      @media (max-width: 576px) {
        body {
          padding: 10px;
        }
        .container {
          padding: 8px;
        }
        th, td {
          padding: 6px;
          font-size: 0.8rem;
          min-width: 60px;
        }
        .btn {
          width: 100%;
          margin-bottom: 8px;
        }
        #resultado {
          font-size: 0.9rem;
        }
        .add-remove-buttons {
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="top-buttons">
        <button id="btn-salvar" class="btn btn-primary" onclick="salvarEscala()">
          Salvar Escala
        </button>
        <button id="btn-atualizar" class="btn btn-secondary" onclick="atualizarTabela()">
          Atualizar
        </button>
      </div>
      <h2 id="titulo-mes">Escala Mensal de Trabalho</h2>
      <div class="table-fixed">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th colspan="3">Escala Mensal</th>
            </tr>
            <tr>
              <th>Nome</th>
              <th>Função</th>
              <th>Horário</th>
            </tr>
          </thead>
          <tbody id="colaboradores-tbody"></tbody>
        </table>
        <div class="add-remove-buttons">
          <button class="btn btn-primary" onclick="adicionarLinha()">+</button>
          <button class="btn btn-danger" onclick="removerLinha()">-</button>
        </div>
      </div>
      <div class="table-scroll">
        <table class="table table-bordered" id="escala-mensal">
          <thead>
            <tr id="dias-mes"></tr>
            <tr id="dias-semana"></tr>
          </thead>
          <tbody id="corpo-tabela"></tbody>
        </table>
      </div>
      <div class="button-container">
        <button id="btn-gerar" class="btn btn-success" onclick="gerarEscalaDiaSeguinte()">
          Gerar Escala do Dia Seguinte
        </button>
      </div>
      <div id="resultado"></div>
      <button id="btn-copiar" class="btn btn-secondary copy-button" onclick="copiarTexto()">
        Copiar Texto
      </button>
      <div id="feedback-inconsistencia"></div>
    </div>

    <script>
      const colaboradores = [
        "Lidiane",
        "Aline",
        "Jheferson",
        "Luiza",
        "Luiz",
        "Renata",
        "Júlia",
        "Cátia",
        "Erika",
        "Caren",
        "Raissa",
        "Nathan",
        "João",
        "Ronaldo",
      ];
      const funcoes = {
        "🔴 Caixa": "🔴 Caixa",
        "🟢 Pacote": "🟢 Pacote",
        "🟡 Organização": "🟡 Organização",
        "🔵 Venda": "🔵 Venda",
      };

      const horarios = {
        Abertura: [
          "10h às 18h",
          "10h às 19h",
          "10h às 20h",
          "12h às 20h",
          "12h às 18h",
          "12h às 20h",
        ],
        Intermediário: ["12h às 18h", "12h às 20h", "13h às 19h", "14h às 20h"],
        Fechamento: [
          "14h às 22h",
          "13h às 22h",
          "12h às 22h",
          "15h às 22h",
          "13h às 21h",
          "14h às 22h",
        ],
        Folga: ["Folga"],
        Curso: ["Curso"],
      };

      const valoresPadrao = {
        Lidiane: { funcao: "🔴 Caixa", horario: "10h às 18h" },
        Aline: { funcao: "🟢 Pacote", horario: "10h às 18h" },
        Jheferson: { funcao: "🟡 Organização", horario: "10h às 18h" },
        Luiza: { funcao: "🟡 Organização", horario: "10h às 18h" },
        Luiz: { funcao: "🔵 Venda", horario: "10h às 18h" },
        Renata: { funcao: "🔵 Venda", horario: "10h às 18h" },
        Júlia: { funcao: "🟡 Organização", horario: "12h às 18h" },
        Cátia: { funcao: "🔴 Caixa", horario: "14h às 22h" },
        Erika: { funcao: "🟢 Pacote", horario: "14h às 22h" },
        Caren: { funcao: "🟡 Organização", horario: "14h às 22h" },
        Raissa: { funcao: "🟡 Organização", horario: "14h às 22h" },
        Nathan: { funcao: "🔵 Venda", horario: "14h às 22h" },
        João: { funcao: "🔵 Venda", horario: "14h às 22h" },
        Ronaldo: { funcao: "🔵 Venda", horario: "14h às 22h" },
      };

      const status = ["T", "F", "C", "FF", "DO"];

      function gerarTabelaMensal() {
        const diasMes = document.getElementById("dias-mes");
        const diasSemana = document.getElementById("dias-semana");
        const corpoTabela = document.getElementById("corpo-tabela");
        const colaboradoresTbody = document.getElementById(
          "colaboradores-tbody"
        );
        const tituloMes = document.getElementById("titulo-mes");

        const hoje = new Date();
        const mesAtual = hoje.getMonth();
        const anoAtual = hoje.getFullYear();
        const ultimoDia = new Date(anoAtual, mesAtual + 1, 0).getDate();

        // Atualizar título com o mês vigente
        const nomeMes = hoje.toLocaleDateString("pt-BR", { month: "long" });
        tituloMes.innerText = `Escala Mensal de Trabalho - ${
          nomeMes.charAt(0).toUpperCase() + nomeMes.slice(1)
        }`;

        // Cabeçalho com dias do mês
        let diasMesHeader = "";
        let diasSemanaHeader = "";
        for (let dia = 1; dia <= ultimoDia; dia++) {
          const data = new Date(anoAtual, mesAtual, dia);
          const diaSemana = data.toLocaleDateString("pt-BR", {
            weekday: "short",
          });
          diasMesHeader += `<th>${dia}</th>`;
          diasSemanaHeader += `<th class="${
            diaSemana === "dom" ? "domingo" : ""
          }">${diaSemana}</th>`;
        }
        diasMes.innerHTML = diasMesHeader;
        diasSemana.innerHTML = diasSemanaHeader;

        // Corpo da tabela com colaboradores e selects
        let corpoTabelaHtml = "";
        let colaboradoresHtml = "";
        colaboradores.forEach((nome) => {
          const padrao = valoresPadrao[nome] || {
            funcao: "🔴 Caixa",
            horario: "10h às 18h",
          }; // Usa padrão se não houver configuração
          colaboradoresHtml += `<tr>
                    <td class="editable" contenteditable="true">${nome}</td>
                    <td><select>${Object.values(funcoes)
                      .map(
                        (f) =>
                          `<option value="${f}" ${
                            f === padrao.funcao ? "selected" : ""
                          }>${f}</option>`
                      )
                      .join("")}</select></td>
                    <td><select>${Object.values(horarios)
                      .flat()
                      .map(
                        (h) =>
                          `<option value="${h}" ${
                            h === padrao.horario ? "selected" : ""
                          }>${h}</option>`
                      )
                      .join("")}</select></td>
                </tr>`;
          corpoTabelaHtml += `<tr>`;
          for (let dia = 1; dia <= ultimoDia; dia++) {
            corpoTabelaHtml += `<td><select>${status
              .map((s) => `<option value="${s}">${s}</option>`)
              .join("")}</select></td>`;
          }
          corpoTabelaHtml += "</tr>";
        });
        colaboradoresTbody.innerHTML = colaboradoresHtml;
        corpoTabela.innerHTML = corpoTabelaHtml;

        // Carregar estado salvo
        carregarEscala();

        // Atualizar cores da tabela
        atualizarCoresTabela();

        // Verificar inconsistências ao carregar
        verificarInconsistencias();
      }

      function adicionarLinha() {
        const colaboradoresTbody = document.getElementById(
          "colaboradores-tbody"
        );
        const corpoTabela = document.getElementById("corpo-tabela");

        const novaLinhaColaboradores = `<tr>
            <td class="editable" contenteditable="true">Novo</td>
            <td><select>${Object.values(funcoes)
              .map((f) => `<option value="${f}">${f}</option>`)
              .join("")}</select></td>
            <td><select>${Object.values(horarios)
              .flat()
              .map((h) => `<option value="${h}">${h}</option>`)
              .join("")}</select></td>
        </tr>`;
        colaboradoresTbody.insertAdjacentHTML(
          "beforeend",
          novaLinhaColaboradores
        );

        const novaLinhaTabela = `<tr>${Array.from({ length: document.getElementById("dias-mes").children.length })
          .map(() => `<td><select>${status.map((s) => `<option value="${s}">${s}</option>`).join("")}</select></td>`)
          .join("")}</tr>`;
        corpoTabela.insertAdjacentHTML("beforeend", novaLinhaTabela);

        // Atualizar cores da tabela e verificar inconsistências
        atualizarCoresTabela();
        verificarInconsistencias();
      }

      function removerLinha() {
        const colaboradoresTbody = document.getElementById(
          "colaboradores-tbody"
        );
        const corpoTabela = document.getElementById("corpo-tabela");

        if (colaboradoresTbody.children.length > 0) {
          colaboradoresTbody.removeChild(colaboradoresTbody.lastElementChild);
          corpoTabela.removeChild(corpoTabela.lastElementChild);
        }

        // Atualizar cores da tabela e verificar inconsistências
        atualizarCoresTabela();
        verificarInconsistencias();
      }

      function salvarEscala() {
        const estado = [];
        const linhasColaboradores = document.querySelectorAll(
          "#colaboradores-tbody tr"
        );
        const linhasTabela = document.querySelectorAll("#corpo-tabela tr");

        linhasColaboradores.forEach((tr, index) => {
          const nome = tr.querySelector("td:nth-child(1)").innerText;
          const funcao = tr.querySelector("td:nth-child(2) select").value;
          const horario = tr.querySelector("td:nth-child(3) select").value;
          const statusDias = [];
          linhasTabela[index]
            .querySelectorAll("td select")
            .forEach((select) => {
              statusDias.push(select.value);
            });
          estado.push({ nome, funcao, horario, statusDias });
        });
        localStorage.setItem("escalaSalva", JSON.stringify(estado));

        // Feedback visual: muda o texto do botão temporariamente
        const btnSalvar = document.getElementById("btn-salvar");
        btnSalvar.innerText = "Salvo";
        setTimeout(() => {
          btnSalvar.innerText = "Salvar Escala";
        }, 3000);

        // Verificar inconsistências após salvar
        verificarInconsistencias();
      }

      function carregarEscala() {
        const estadoSalvo = localStorage.getItem("escalaSalva");
        if (estadoSalvo) {
          const estado = JSON.parse(estadoSalvo);
          const linhasColaboradores = document.querySelectorAll(
            "#colaboradores-tbody tr"
          );
          const linhasTabela = document.querySelectorAll("#corpo-tabela tr");

          estado.forEach((colaborador, index) => {
            if (linhasColaboradores[index]) {
              linhasColaboradores[index].querySelector(
                "td:nth-child(1)"
              ).innerText = colaborador.nome;
              linhasColaboradores[index].querySelector(
                "td:nth-child(2) select"
              ).value = colaborador.funcao;
              linhasColaboradores[index].querySelector(
                "td:nth-child(3) select"
              ).value = colaborador.horario;
            }
            if (linhasTabela[index]) {
              colaborador.statusDias.forEach((statusDia, i) => {
                linhasTabela[index].querySelector(
                  `td:nth-child(${i + 1}) select`
                ).value = statusDia;
              });
            }
          });
        }

        // Atualizar cores da tabela e verificar inconsistências
        atualizarCoresTabela();
        verificarInconsistencias();
      }

      function atualizarCoresTabela() {
        const linhasTabela = document.querySelectorAll("#corpo-tabela tr");
        linhasTabela.forEach((tr) => {
          tr.querySelectorAll("td select").forEach((select) => {
            const status = select.value;
            select.parentElement.classList.remove("trabalhado", "folga");
            if (status === "T") {
              select.parentElement.classList.add("trabalhado");
            } else if (["F", "FF", "DO"].includes(status)) {
              select.parentElement.classList.add("folga");
            }
          });
        });
      }

      function verificarInconsistencias() {
        const linhasTabela = document.querySelectorAll("#corpo-tabela tr");
        const feedbackInconsistencia = document.getElementById(
          "feedback-inconsistencia"
        );
        let inconsistencias = [];

        linhasTabela.forEach((tr, index) => {
          const nome = document
            .querySelectorAll("#colaboradores-tbody tr")
            [index].querySelector("td:nth-child(1)").innerText;
          const selects = tr.querySelectorAll("td select");

          let diasConsecutivos = 0;
          let diasInconsistentes = [];
          selects.forEach((select, dia) => {
            if (select.value === "T") {
              diasConsecutivos++;
              if (diasConsecutivos > 6) {
                diasInconsistentes.push(dia + 1);
              }
            } else {
              diasConsecutivos = 0;
            }
          });

          if (diasInconsistentes.length > 0) {
            inconsistencias.push({
              nome,
              dias: diasInconsistentes,
            });
          }
        });

        if (inconsistencias.length > 0) {
          const mensagem = inconsistencias
            .map(
              (item) =>
                `${item.nome} tem mais de 6 dias consecutivos trabalhados nos dias ${item.dias.join(", ")}`
            )
            .join("<br>");
          feedbackInconsistencia.innerHTML = `<strong>Inconsistências encontradas:</strong><br>${mensagem}`;
        } else {
          feedbackInconsistencia.innerHTML = "";
        }
      }

      function atualizarTabela() {
        const btnAtualizar = document.getElementById("btn-atualizar");
        btnAtualizar.innerText = "Atualizado";
        setTimeout(() => {
          btnAtualizar.innerText = "Atualizar";
        }, 3000);

        atualizarCoresTabela();
        verificarInconsistencias();
      }

      function gerarEscalaDiaSeguinte() {
        const btnGerar = document.getElementById("btn-gerar");
        btnGerar.innerText = "Gerando...";

        setTimeout(() => {
          const hoje = new Date();
          const diaSeguinte = new Date(hoje);
          diaSeguinte.setDate(hoje.getDate() + 1);

          const dia = diaSeguinte.getDate();
          const diaSemana = diaSeguinte.toLocaleDateString("pt-BR", {
            weekday: "long",
          });

          let escalaTexto = `Escala - ${diaSemana}, ${diaSeguinte.toLocaleDateString(
            "pt-BR"
          )}\n\n`;

          const linhasColaboradores = document.querySelectorAll(
            "#colaboradores-tbody tr"
          );
          const linhasTabela = document.querySelectorAll("#corpo-tabela tr");

          // Captura os valores atuais dos selects e inputs
          const colaboradoresEscala = Array.from(linhasColaboradores).map(
            (tr, index) => {
              const nome = tr.querySelector("td:nth-child(1)").innerText;
              const funcao = tr.querySelector("td:nth-child(2) select").value;
              const horario = tr.querySelector("td:nth-child(3) select").value;
              const statusDia = linhasTabela[index].querySelector(
                `td:nth-child(${dia}) select`
              ).value;
              return { nome, funcao, horario, statusDia };
            }
          );

          // Agrupar por horários
          const abertura = colaboradoresEscala.filter(
            (c) =>
              horarios["Abertura"].includes(c.horario) && c.statusDia === "T"
          );
          const intermediario = colaboradoresEscala.filter(
            (c) =>
              horarios["Intermediário"].includes(c.horario) &&
              c.statusDia === "T"
          );
          const fechamento = colaboradoresEscala.filter(
            (c) =>
              horarios["Fechamento"].includes(c.horario) && c.statusDia === "T"
          );

          // Gerar texto para abertura
          if (abertura.length > 0) {
            escalaTexto += "Abertura\n";
            abertura.forEach((c) => {
              escalaTexto += `${c.funcao} - ${c.nome} - ${c.horario}\n`;
            });
          }

          // Gerar texto para intermediário
          if (intermediario.length > 0) {
            escalaTexto += "\nIntermediário\n";
            intermediario.forEach((c) => {
              escalaTexto += `${c.funcao} - ${c.nome} - ${c.horario}\n`;
            });
          }

          // Gerar texto para fechamento
          if (fechamento.length > 0) {
            escalaTexto += "\nFechamento\n";
            fechamento.forEach((c) => {
              escalaTexto += `${c.funcao} - ${c.nome} - ${c.horario}\n`;
            });
          }

          // Listar folgas
          const folgas = colaboradoresEscala
            .filter((c) => ["F", "FF", "DO"].includes(c.statusDia))
            .map((c) => {
              let motivo = "";
              if (c.statusDia === "F") motivo = "Folga";
              else if (c.statusDia === "FF") motivo = "Folga Feriado";
              else if (c.statusDia === "DO") motivo = "DAY OFF";
              return `${c.nome} (${motivo})`;
            });

          if (folgas.length > 0) {
            escalaTexto += `\nFolgas:\n${folgas.join(", ")}\n`;
          }

          // Listar cursos (apenas para Júlia)
          const cursos = colaboradoresEscala
            .filter((c) => c.statusDia === "C" && c.nome === "Júlia")
            .map((c) => c.nome);
          if (cursos.length > 0) {
            escalaTexto += `\nCurso:\n${cursos.join(", ")}\n`;
          }

          document.getElementById("resultado").innerText = escalaTexto;
          btnGerar.innerText = "Escala Gerada";
          setTimeout(() => {
            btnGerar.innerText = "Gerar Escala do Dia Seguinte";
          }, 3000);
        }, 1000); // Simula um pequeno atraso para processamento
      }

      function copiarTexto() {
        const texto = document.getElementById("resultado").innerText;
        navigator.clipboard.writeText(texto).then(() => {
          const btnCopiar = document.getElementById("btn-copiar");
          btnCopiar.innerText = "Copiado";
          setTimeout(() => {
            btnCopiar.innerText = "Copiar Texto";
          }, 3000);
        });
      }

      // Event delegation para salvar estado ao alterar selects
      document
        .getElementById("colaboradores-tbody")
        .addEventListener("change", salvarEscala);
      document
        .getElementById("corpo-tabela")
        .addEventListener("change", salvarEscala);

      // Atualizar automaticamente ao alterar a tabela
      document
        .getElementById("corpo-tabela")
        .addEventListener("change", atualizarTabela);

      gerarTabelaMensal();
    </script>
  </body>
</html>